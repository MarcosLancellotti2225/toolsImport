<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador CSV para CLI - Signaturit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
        }

        .step-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .command-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .command-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            font-size: 0.95em;
        }

        .command-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
        }

        .command-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .command-category {
            font-size: 0.75em;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .command-name {
            font-weight: 600;
            font-size: 1.1em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #eef0ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #eef0ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .mapping-section {
            display: none;
        }

        .mapping-section.active {
            display: block;
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .mapping-table th,
        .mapping-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .mapping-table th {
            background: #f8f9ff;
            color: #667eea;
            font-weight: 600;
        }

        .mapping-table select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .preview-section {
            display: none;
            margin-top: 30px;
        }

        .preview-section.active {
            display: block;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            max-height: 300px;
            overflow: auto;
            display: block;
        }

        .preview-table th,
        .preview-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .preview-table th {
            background: #667eea;
            color: white;
            position: sticky;
            top: 0;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .columns-info {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .columns-info strong {
            color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .mapping-summary {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .mapping-summary strong {
            color: #2e7d32;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input[type="checkbox"] {
            cursor: pointer;
            accent-color: #667eea;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .btn-primary:hover {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Generador CSV para CLI</h1>
            <p>Convierte tus Excel al formato correcto para los comandos del sistema</p>
        </div>

        <div class="content">
            <!-- PASO 1: Seleccionar Comando -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Selecciona el comando CLI
                </div>
                
                <div class="command-grid" id="commandGrid"></div>
                
                <div id="columnsInfo" class="columns-info" style="display: none;">
                    <strong>Columnas requeridas:</strong>
                    <div id="requiredColumns"></div>
                </div>
            </div>

            <!-- PASO 2: Crear o Cargar Excel -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">2</span>
                    ¬øCrear template o convertir Excel existente?
                </div>
                
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" id="createTemplateBtn" style="flex: 1;">
                        üìÑ Crear Template Vac√≠o
                    </button>
                    <button class="btn btn-primary" id="loadExcelBtn" style="flex: 1; background: #28a745;">
                        üìÅ Cargar Excel Existente
                    </button>
                </div>

                <div class="info-box" id="modeInfo" style="display: none;">
                    <span id="modeInfoText"></span>
                </div>
                
                <div class="upload-area" id="uploadArea" style="display: none;">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Arrastra tu archivo Excel aqu√≠</h3>
                    <p>o haz clic para seleccionar</p>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                </div>

                <div id="headerOption" style="display: none; margin-top: 20px;">
                    <div style="background: #f8f9ff; padding: 20px; border-radius: 10px; border: 2px solid #667eea;">
                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 1.1em;">
                            <input type="checkbox" id="hasHeaderRow" checked style="width: 20px; height: 20px; cursor: pointer; margin-top: 3px;">
                            <span>
                                <strong>La primera fila contiene t√≠tulos de columnas</strong>
                                <small style="display: block; color: #666; margin-top: 8px; line-height: 1.5;">
                                    <strong>‚úÖ CON encabezados (marcado):</strong><br>
                                    <code style="background: #e8f5e9; padding: 3px 6px; border-radius: 3px; font-size: 0.9em;">
                                        userid | email | nombre | apellidos
                                    </code><br>
                                    <code style="background: white; padding: 3px 6px; border-radius: 3px; font-size: 0.9em;">
                                        jperez | juan@mail.com | Juan | P√©rez
                                    </code>
                                    <br><br>
                                    <strong>‚ùå SIN encabezados (desmarcado):</strong><br>
                                    <code style="background: white; padding: 3px 6px; border-radius: 3px; font-size: 0.9em;">
                                        jperez | juan@mail.com | Juan | P√©rez
                                    </code><br>
                                    <code style="background: white; padding: 3px 6px; border-radius: 3px; font-size: 0.9em;">
                                        mlopez | maria@mail.com | Maria | L√≥pez
                                    </code><br>
                                    <small style="color: #f57c00;">‚ö†Ô∏è Se usar√°n nombres gen√©ricos: Columna1, Columna2, etc.</small>
                                </small>
                            </span>
                        </label>
                    </div>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="processFileBtn" style="width: 100%;">
                            ‚úÖ Procesar Archivo
                        </button>
                    </div>
                </div>

                <div id="templateCreated" style="display: none;">
                    <div class="success-box">
                        ‚úÖ <strong>Template listo para exportar!</strong> Dale un nombre personalizado (ej: Template_Urbaser, Template_Cliente_X)
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">
                            üìù Nombre del template (opcional):
                        </label>
                        <input 
                            type="text" 
                            id="templateNameInput" 
                            placeholder="ej: Template_Urbaser_Users"
                            style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em;">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Si lo dejas vac√≠o se llamar√°: template_[comando].xlsx
                        </small>
                    </div>
                    
                    <button class="btn btn-primary" id="downloadTemplateBtn" style="width: 100%;">
                        üì• Descargar Template Excel
                    </button>
                </div>
            </div>

            <!-- PASO 3: Mapear Columnas -->
            <div class="step mapping-section" id="mappingSection">
                <div class="step-title">
                    <span class="step-number">3</span>
                    Verifica el mapeo autom√°tico
                </div>
                
                <div class="info-box">
                    üí° <strong>Mapeo autom√°tico detectado:</strong> Revisa que las columnas est√©n bien emparejadas. Si algo est√° mal, aj√∫stalo manualmente.
                </div>

                <div class="button-group" style="margin: 20px 0;">
                    <button class="btn btn-primary" id="autoProcessBtn" style="background: #28a745; flex: 2; font-size: 1.1em;">
                        ‚ö° Auto-Procesar (Mapeo OK ‚Üí Generar CSV)
                    </button>
                    <button class="btn btn-primary" id="manualMappingBtn" style="flex: 1;">
                        üîß Ajustar Mapeo Manualmente
                    </button>
                </div>

                <div id="mappingDetails" style="display: none;">
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">Mapeo detectado:</h3>
                    
                    <table class="mapping-table" id="mappingTable">
                        <thead>
                            <tr>
                                <th>Columna Requerida (CSV)</th>
                                <th>Columna de tu Excel</th>
                                <th>Valor por defecto (opcional)</th>
                            </tr>
                        </thead>
                        <tbody id="mappingBody">
                        </tbody>
                    </table>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="applyMappingBtn">
                            ‚úÖ Aplicar Mapeo y Continuar
                        </button>
                    </div>
                </div>
            </div>

            <!-- PASO 4: Preview y Descarga -->
            <div class="preview-section" id="previewSection">
                <div class="step-title">
                    <span class="step-number">4</span>
                    Preview y descarga
                </div>
                
                <div class="success-box">
                    ‚úÖ <strong>¬°Listo para procesar!</strong> 
                    <span id="rowCount"></span>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewTable">
                        <thead id="previewHead"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>

                <div style="margin: 30px 0 20px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea; font-size: 1.1em;">
                        üìù Nombre del archivo CSV:
                    </label>
                    <input 
                        type="text" 
                        id="csvNameInput" 
                        placeholder="nombre-archivo"
                        style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1.1em; font-family: monospace;">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        El archivo se descargar√° como: <strong><span id="csvNamePreview"></span>.csv</strong>
                    </small>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="downloadBtn" style="font-size: 1.2em; padding: 20px 40px;">
                        üöÄ Procesar y Descargar CSV
                    </button>
                </div>
                
                <div class="button-group" style="margin-top: 10px;">
                    <button class="btn btn-primary" id="resetBtn" style="background: #6c757d;">
                        üîÑ Empezar de nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Definici√≥n de templates de comandos
        const COMMAND_TEMPLATES = {
            'users-add': {
                category: 'Users',
                columns: ['userid', 'email', 'nombre', 'apellidos', 'dni', 'telefono', 'rol', 'password']
            },
            'users-set': {
                category: 'Users',
                columns: ['userid', 'nombre', 'apellidos', 'dni', 'email']
            },
            'users-remove': {
                category: 'Users',
                columns: ['orgaid', 'userid']
            },
            'certs-import': {
                category: 'Certs',
                columns: ['cert_pfx', 'cert_password', 'cert_name', 'descr', 'cert_pin', 'userid', 'orgaid', 'cargo', 'departamento', 'personalizado']
            },
            'certs-del': {
                category: 'Certs',
                columns: ['certid']
            },
            'certs-pinset': {
                category: 'Certs',
                columns: ['certid', 'pin_antiguo', 'pin_nuevo']
            },
            'delegs-add': {
                category: 'Delegs',
                columns: ['certid', 'delegate_name', 'description', 'Ignorecertrules', 'needauth']
            },
            'delegs-usersadd': {
                category: 'Delegs',
                columns: ['delegid', 'orgaid', 'cert_userid', 'cert_pin', 'cert_deleg_pin', 'notify']
            },
            'delegs-del': {
                category: 'Delegs',
                columns: ['delegid']
            },
            'delegs-usersdel': {
                category: 'Delegs',
                columns: ['delegid', 'userid']
            },
            'rules-add': {
                category: 'Rules',
                columns: ['certid']
            }
        };

        // Estado global
        let state = {
            selectedCommand: null,
            excelData: null,
            excelColumns: [],
            mapping: {},
            defaultValues: {},
            mode: null // 'create' o 'convert'
        };

        // Renderizar botones de comandos
        function renderCommandButtons() {
            const grid = document.getElementById('commandGrid');
            grid.innerHTML = '';

            Object.keys(COMMAND_TEMPLATES).forEach(cmd => {
                const template = COMMAND_TEMPLATES[cmd];
                const btn = document.createElement('button');
                btn.className = 'command-btn';
                btn.innerHTML = `
                    <div class="command-category">${template.category}</div>
                    <div class="command-name">${cmd}</div>
                `;
                btn.onclick = () => selectCommand(cmd);
                grid.appendChild(btn);
            });
        }

        // Seleccionar comando
        function selectCommand(cmd) {
            state.selectedCommand = cmd;
            
            // Update UI
            document.querySelectorAll('.command-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.command-btn').classList.add('active');

            // Mostrar columnas requeridas
            const template = COMMAND_TEMPLATES[cmd];
            const columnsInfo = document.getElementById('columnsInfo');
            const requiredColumns = document.getElementById('requiredColumns');
            
            requiredColumns.innerHTML = template.columns.map(col => 
                `<span style="display: inline-block; background: #667eea; color: white; padding: 5px 10px; margin: 5px; border-radius: 5px; font-size: 0.9em;">${col}</span>`
            ).join('');
            
            columnsInfo.style.display = 'block';
        }

        // Configurar zona de carga
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        // Botones de modo
        document.getElementById('createTemplateBtn').onclick = () => {
            if (!state.selectedCommand) {
                alert('‚ö†Ô∏è Primero selecciona un comando');
                return;
            }
            createTemplateMode();
        };

        document.getElementById('loadExcelBtn').onclick = () => {
            if (!state.selectedCommand) {
                alert('‚ö†Ô∏è Primero selecciona un comando');
                return;
            }
            loadExcelMode();
        };

        // Modo: Crear Template
        function createTemplateMode() {
            state.mode = 'create';
            document.getElementById('modeInfo').style.display = 'block';
            document.getElementById('modeInfoText').innerHTML = 'üìÑ <strong>Modo: Crear Template</strong> - Se generar√° un Excel vac√≠o con las columnas correctas';
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('templateCreated').style.display = 'block';
            document.getElementById('headerOption').style.display = 'none';
        }

        // Modo: Cargar Excel
        function loadExcelMode() {
            state.mode = 'convert';
            document.getElementById('modeInfo').style.display = 'block';
            document.getElementById('modeInfoText').innerHTML = 'üìÅ <strong>Modo: Convertir Excel</strong> - Carga tu Excel desordenado y lo convertiremos';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('templateCreated').style.display = 'none';
            document.getElementById('headerOption').style.display = 'none'; // Se mostrar√° despu√©s de cargar el archivo
        }

        // Crear y descargar template Excel vac√≠o
        document.getElementById('downloadTemplateBtn').onclick = () => {
            const template = COMMAND_TEMPLATES[state.selectedCommand];
            
            // Crear workbook vac√≠o con las columnas correctas
            const ws_data = [template.columns]; // Solo el header
            
            // Agregar algunas filas de ejemplo vac√≠as (10 filas)
            for (let i = 0; i < 10; i++) {
                ws_data.push(new Array(template.columns.length).fill(''));
            }
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Dar formato a las columnas (ancho autom√°tico)
            const colWidths = template.columns.map(col => ({wch: Math.max(col.length + 2, 15)}));
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");
            
            // Obtener nombre personalizado o usar el default
            const customName = document.getElementById('templateNameInput').value.trim();
            const fileName = customName 
                ? `${customName}.xlsx`
                : `template_${state.selectedCommand}.xlsx`;
            
            // Descargar
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ Template descargado!\n\nüìÑ Archivo: ${fileName}\n\nüìù Instrucciones:\n1. Abre el archivo Excel\n2. Compl√©talo con tus datos\n3. Vuelve aqu√≠ y usa "Cargar Excel Existente"\n4. El sistema lo detectar√° autom√°ticamente y podr√°s procesarlo`);
        };

        uploadArea.onclick = () => fileInput.click();

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });

        // Procesar archivo
        let rawExcelData = null; // Para guardar los datos sin procesar

        function handleFile(file) {
            if (!state.selectedCommand) {
                alert('‚ö†Ô∏è Primero selecciona un comando');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Leer como array de arrays para tener control total
                    rawExcelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });
                    
                    if (rawExcelData.length === 0) {
                        alert('‚ö†Ô∏è El archivo est√° vac√≠o');
                        return;
                    }

                    // Mostrar opci√≥n de header
                    document.getElementById('headerOption').style.display = 'block';
                    
                } catch (error) {
                    alert('‚ùå Error al leer el archivo: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Procesar archivo seg√∫n opci√≥n de header
        document.getElementById('processFileBtn').onclick = () => {
            const hasHeader = document.getElementById('hasHeaderRow').checked;
            processExcelData(rawExcelData, hasHeader);
        };

        function processExcelData(rawData, hasHeader) {
            const template = COMMAND_TEMPLATES[state.selectedCommand];

            if (hasHeader) {
                // Modo normal: primera fila son headers
                const headers = rawData[0];
                const dataRows = rawData.slice(1);
                
                state.excelColumns = headers.map(h => String(h).trim());
                state.excelData = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, idx) => {
                        obj[String(header).trim()] = row[idx] || '';
                    });
                    return obj;
                });
            } else {
                // Sin headers: generar nombres gen√©ricos
                const numColumns = rawData[0].length;
                state.excelColumns = Array.from({ length: numColumns }, (_, i) => `Columna${i + 1}`);
                
                state.excelData = rawData.map(row => {
                    const obj = {};
                    state.excelColumns.forEach((colName, idx) => {
                        obj[colName] = row[idx] || '';
                    });
                    return obj;
                });
            }

            if (state.excelData.length === 0) {
                alert('‚ö†Ô∏è No hay datos para procesar');
                return;
            }

            // Verificar si el Excel cargado ya tiene las columnas correctas (modo create)
            const hasCorrectColumns = template.columns.every(col => 
                state.excelColumns.includes(col)
            );

            if (hasCorrectColumns && state.excelColumns.length === template.columns.length) {
                // Excel ya tiene formato correcto, mapeo directo
                state.mapping = {};
                template.columns.forEach(col => {
                    state.mapping[col] = col;
                });
                document.getElementById('mappingSection').style.display = 'none';
                generatePreview();
                alert('‚úÖ Excel con formato correcto detectado! Generando preview...');
            } else {
                // Excel desordenado, necesita mapeo
                setupMapping();
            }
        }

        // Configurar mapeo de columnas
        function setupMapping() {
            const template = COMMAND_TEMPLATES[state.selectedCommand];
            const mappingBody = document.getElementById('mappingBody');
            mappingBody.innerHTML = '';

            // Auto-mapear columnas similares
            let autoMappedCount = 0;
            template.columns.forEach(requiredCol => {
                const normalizedRequired = requiredCol.toLowerCase().replace(/[_-]/g, '');
                
                let matchedCol = null;
                for (let excelCol of state.excelColumns) {
                    const normalizedExcel = excelCol.toLowerCase().replace(/[_-]/g, '');
                    if (normalizedExcel === normalizedRequired || 
                        normalizedExcel.includes(normalizedRequired) ||
                        normalizedRequired.includes(normalizedExcel)) {
                        matchedCol = excelCol;
                        autoMappedCount++;
                        break;
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${requiredCol}</strong></td>
                    <td>
                        <select class="column-mapping" data-required="${requiredCol}">
                            <option value="">-- No mapear --</option>
                            ${state.excelColumns.map(col => 
                                `<option value="${col}" ${col === matchedCol ? 'selected' : ''}>${col}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" 
                               class="default-value" 
                               data-required="${requiredCol}"
                               placeholder="Valor fijo (opcional)"
                               style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 5px;">
                    </td>
                `;
                mappingBody.appendChild(row);

                // Inicializar mapping
                if (matchedCol) {
                    state.mapping[requiredCol] = matchedCol;
                }
            });

            // Mostrar secci√≥n de mapeo
            document.getElementById('mappingSection').classList.add('active');

            // Event listeners para actualizaci√≥n de mapeo
            document.querySelectorAll('.column-mapping').forEach(select => {
                select.addEventListener('change', updateMapping);
            });

            document.querySelectorAll('.default-value').forEach(input => {
                input.addEventListener('input', updateMapping);
            });

            // Configurar botones
            const autoMappingSuccess = autoMappedCount === template.columns.length;
            
            document.getElementById('autoProcessBtn').onclick = () => {
                updateMapping();
                generatePreview();
                alert(`‚ö° Auto-procesamiento completado!\n\n‚úÖ ${autoMappedCount}/${template.columns.length} columnas mapeadas autom√°ticamente\n\nRevisa el preview y descarga tu CSV.`);
            };

            document.getElementById('manualMappingBtn').onclick = () => {
                document.getElementById('mappingDetails').style.display = 'block';
                document.getElementById('autoProcessBtn').style.display = 'none';
                document.getElementById('manualMappingBtn').style.display = 'none';
            };

            document.getElementById('applyMappingBtn').onclick = () => {
                updateMapping();
                generatePreview();
            };

            // Si el mapeo autom√°tico es perfecto, sugerirlo
            if (autoMappingSuccess) {
                setTimeout(() => {
                    if (confirm(`üéØ ¬°Mapeo autom√°tico perfecto!\n\n‚úÖ Todas las columnas (${autoMappedCount}) fueron mapeadas correctamente.\n\n¬øQuieres procesar directamente?`)) {
                        updateMapping();
                        generatePreview();
                    }
                }, 500);
            }

            // Generar preview inicial
            updateMapping();
        }

        // Actualizar mapeo
        function updateMapping() {
            state.mapping = {};
            state.defaultValues = {};

            document.querySelectorAll('.column-mapping').forEach(select => {
                const required = select.dataset.required;
                const selected = select.value;
                if (selected) {
                    state.mapping[required] = selected;
                }
            });

            document.querySelectorAll('.default-value').forEach(input => {
                const required = input.dataset.required;
                const value = input.value.trim();
                if (value) {
                    state.defaultValues[required] = value;
                }
            });

            // Mostrar resumen del mapeo
            showMappingSummary();

            generatePreview();
        }

        // Mostrar resumen del mapeo
        function showMappingSummary() {
            const template = COMMAND_TEMPLATES[state.selectedCommand];
            const mappedCount = Object.keys(state.mapping).length;
            const defaultCount = Object.keys(state.defaultValues).length;
            const totalRequired = template.columns.length;
            const unmappedCount = totalRequired - mappedCount - defaultCount;

            // Crear o actualizar el resumen
            let summaryDiv = document.getElementById('mappingSummary');
            if (!summaryDiv) {
                summaryDiv = document.createElement('div');
                summaryDiv.id = 'mappingSummary';
                summaryDiv.className = 'mapping-summary';
                const mappingSection = document.getElementById('mappingSection');
                mappingSection.insertBefore(summaryDiv, document.getElementById('mappingDetails'));
            }

            summaryDiv.innerHTML = `
                <strong>üìä Estado del mapeo:</strong><br>
                ‚úÖ Mapeadas: ${mappedCount}/${totalRequired} columnas<br>
                üîß Con valor por defecto: ${defaultCount}<br>
                ${unmappedCount > 0 ? `‚ö†Ô∏è Sin mapear: ${unmappedCount} (quedar√°n vac√≠as)` : '‚ú® ¬°Mapeo completo!'}
            `;
        }

        // Generar preview
        function generatePreview() {
            const template = COMMAND_TEMPLATES[state.selectedCommand];
            const previewHead = document.getElementById('previewHead');
            const previewBody = document.getElementById('previewBody');

            // Header
            previewHead.innerHTML = `
                <tr>
                    ${template.columns.map(col => `<th>${col}</th>`).join('')}
                </tr>
            `;

            // Body (primeras 10 filas)
            previewBody.innerHTML = '';
            const previewRows = state.excelData.slice(0, 10);

            previewRows.forEach(row => {
                const tr = document.createElement('tr');
                template.columns.forEach(col => {
                    const td = document.createElement('td');
                    
                    // Obtener valor: primero default, luego mapeado, luego vac√≠o
                    let value = '';
                    if (state.defaultValues[col]) {
                        value = state.defaultValues[col];
                    } else if (state.mapping[col]) {
                        value = row[state.mapping[col]] || '';
                    }
                    
                    td.textContent = value;
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            });

            // Actualizar contador de filas
            const totalRows = state.excelData.length;
            document.getElementById('rowCount').textContent = 
                `Se procesar√°n ${totalRows} fila${totalRows !== 1 ? 's' : ''}.`;

            // Inicializar nombre del CSV
            const csvNameInput = document.getElementById('csvNameInput');
            if (!csvNameInput.value) {
                csvNameInput.value = state.selectedCommand;
            }
            updateCSVNamePreview();

            // Event listener para actualizar preview del nombre
            csvNameInput.oninput = updateCSVNamePreview;

            // Mostrar secci√≥n de preview
            document.getElementById('previewSection').classList.add('active');
        }

        // Actualizar preview del nombre del CSV
        function updateCSVNamePreview() {
            const csvNameInput = document.getElementById('csvNameInput');
            const csvNamePreview = document.getElementById('csvNamePreview');
            const name = csvNameInput.value.trim() || state.selectedCommand;
            csvNamePreview.textContent = name;
        }

        // Generar CSV
        function generateCSV() {
            const template = COMMAND_TEMPLATES[state.selectedCommand];
            const rows = [];

            // Header
            rows.push(template.columns.join(';'));

            // Data
            state.excelData.forEach(row => {
                const csvRow = template.columns.map(col => {
                    let value = '';
                    
                    // Obtener valor: primero default, luego mapeado
                    if (state.defaultValues[col]) {
                        value = state.defaultValues[col];
                    } else if (state.mapping[col]) {
                        value = row[state.mapping[col]] || '';
                    }
                    
                    // Escapar punto y coma y comillas
                    value = String(value).replace(/"/g, '""');
                    if (value.includes(';') || value.includes('\n') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    
                    return value;
                }).join(';');
                
                rows.push(csvRow);
            });

            return rows.join('\r\n');
        }

        // Descargar CSV
        document.getElementById('downloadBtn').onclick = () => {
            const csv = generateCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Obtener nombre personalizado del CSV
            const csvNameInput = document.getElementById('csvNameInput');
            const fileName = csvNameInput.value.trim() || state.selectedCommand;
            
            link.setAttribute('href', url);
            link.setAttribute('download', `${fileName}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Mostrar mensaje de √©xito
            const totalRows = state.excelData.length;
            alert(`‚úÖ CSV generado con √©xito!\n\nüìä Estad√≠sticas:\n- Comando: ${state.selectedCommand}\n- Filas procesadas: ${totalRows}\n- Columnas: ${COMMAND_TEMPLATES[state.selectedCommand].columns.length}\n\nüíæ Archivo: ${fileName}.csv`);
        };

        // Reset
        document.getElementById('resetBtn').onclick = () => {
            location.reload();
        };

        // Inicializar
        renderCommandButtons();
    </script>
</body>
</html>
